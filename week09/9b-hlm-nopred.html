<!DOCTYPE html>
<html lang="en"><head>
<script src="9b-hlm-nopred_files/libs/clipboard/clipboard.min.js"></script>
<script src="9b-hlm-nopred_files/libs/quarto-html/tabby.min.js"></script>
<script src="9b-hlm-nopred_files/libs/quarto-html/popper.min.js"></script>
<script src="9b-hlm-nopred_files/libs/quarto-html/tippy.umd.min.js"></script>
<link href="9b-hlm-nopred_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="9b-hlm-nopred_files/libs/quarto-html/light-border.css" rel="stylesheet">
<link href="9b-hlm-nopred_files/libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" id="quarto-text-highlighting-styles"><meta charset="utf-8">
  <meta name="generator" content="quarto-1.8.26">

  <meta name="author" content="Dr.&nbsp;Mine Dogucu">
  <title>Hierarchical Linear Models with No Predictors</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="9b-hlm-nopred_files/libs/revealjs/dist/reset.css">
  <link rel="stylesheet" href="9b-hlm-nopred_files/libs/revealjs/dist/reveal.css">
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    html { -webkit-text-size-adjust: 100%; }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      { color: #003b4f; background-color: #f1f3f5; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span { color: #003b4f; } /* Normal */
    code span.al { color: #ad0000; } /* Alert */
    code span.an { color: #5e5e5e; } /* Annotation */
    code span.at { color: #657422; } /* Attribute */
    code span.bn { color: #ad0000; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #003b4f; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #20794d; } /* Char */
    code span.cn { color: #8f5902; } /* Constant */
    code span.co { color: #5e5e5e; } /* Comment */
    code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
    code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
    code span.dt { color: #ad0000; } /* DataType */
    code span.dv { color: #ad0000; } /* DecVal */
    code span.er { color: #ad0000; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #ad0000; } /* Float */
    code span.fu { color: #4758ab; } /* Function */
    code span.im { color: #00769e; } /* Import */
    code span.in { color: #5e5e5e; } /* Information */
    code span.kw { color: #003b4f; font-weight: bold; } /* Keyword */
    code span.op { color: #5e5e5e; } /* Operator */
    code span.ot { color: #003b4f; } /* Other */
    code span.pp { color: #ad0000; } /* Preprocessor */
    code span.sc { color: #5e5e5e; } /* SpecialChar */
    code span.ss { color: #20794d; } /* SpecialString */
    code span.st { color: #20794d; } /* String */
    code span.va { color: #111111; } /* Variable */
    code span.vs { color: #20794d; } /* VerbatimString */
    code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="9b-hlm-nopred_files/libs/revealjs/dist/theme/quarto-d0e4eec2d26d0539cf9d21248d71fa40.css">
  <link href="9b-hlm-nopred_files/libs/revealjs/plugin/quarto-line-highlight/line-highlight.css" rel="stylesheet">
  <link href="9b-hlm-nopred_files/libs/revealjs/plugin/reveal-menu/menu.css" rel="stylesheet">
  <link href="9b-hlm-nopred_files/libs/revealjs/plugin/reveal-menu/quarto-menu.css" rel="stylesheet">
  <link href="9b-hlm-nopred_files/libs/revealjs/plugin/quarto-support/footer.css" rel="stylesheet">
  <style type="text/css">
    .reveal div.sourceCode {
      margin: 0;
      overflow: auto;
    }
    .reveal div.hanging-indent {
      margin-left: 1em;
      text-indent: -1em;
    }
    .reveal .slide:not(.center) {
      height: 100%;
    }
    .reveal .slide.scrollable {
      overflow-y: auto;
    }
    .reveal .footnotes {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide .absolute {
      position: absolute;
      display: block;
    }
    .reveal .footnotes ol {
      counter-reset: ol;
      list-style-type: none; 
      margin-left: 0;
    }
    .reveal .footnotes ol li:before {
      counter-increment: ol;
      content: counter(ol) ". "; 
    }
    .reveal .footnotes ol li > p:first-child {
      display: inline-block;
    }
    .reveal .slide ul,
    .reveal .slide ol {
      margin-bottom: 0.5em;
    }
    .reveal .slide ul li,
    .reveal .slide ol li {
      margin-top: 0.4em;
      margin-bottom: 0.2em;
    }
    .reveal .slide ul[role="tablist"] li {
      margin-bottom: 0;
    }
    .reveal .slide ul li > *:first-child,
    .reveal .slide ol li > *:first-child {
      margin-block-start: 0;
    }
    .reveal .slide ul li > *:last-child,
    .reveal .slide ol li > *:last-child {
      margin-block-end: 0;
    }
    .reveal .slide .columns:nth-child(3) {
      margin-block-start: 0.8em;
    }
    .reveal blockquote {
      box-shadow: none;
    }
    .reveal .tippy-content>* {
      margin-top: 0.2em;
      margin-bottom: 0.7em;
    }
    .reveal .tippy-content>*:last-child {
      margin-bottom: 0.2em;
    }
    .reveal .slide > img.stretch.quarto-figure-center,
    .reveal .slide > img.r-stretch.quarto-figure-center {
      display: block;
      margin-left: auto;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-left,
    .reveal .slide > img.r-stretch.quarto-figure-left  {
      display: block;
      margin-left: 0;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-right,
    .reveal .slide > img.r-stretch.quarto-figure-right  {
      display: block;
      margin-left: auto;
      margin-right: 0; 
    }
  </style>
</head>
<body class="quarto-light">
  <div class="reveal">
    <div class="slides">

<section id="title-slide" data-background-image="https://stats115.com/img/logo.png" data-background-position="50% 85%" data-background-size="5%" class="quarto-title-block center">
  <h1 class="title">Hierarchical Linear Models with No Predictors</h1>

<div class="quarto-title-authors">
<div class="quarto-title-author">
<div class="quarto-title-author-name">
Dr.&nbsp;Mine Dogucu 
</div>
</div>
</div>

</section>
<section id="section" class="slide level2">
<h2></h2>
<p>The notes for this lecture are derived from <a href="https://www.bayesrulesbook.com/chapter-15">Chapters 15 and 16 of the Bayes Rules! book</a></p>
</section>
<section id="data---running" class="slide level2">
<h2>Data - Running</h2>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href=""></a><span class="fu">data</span>(cherry_blossom_sample)</span>
<span id="cb1-2"><a href=""></a></span>
<span id="cb1-3"><a href=""></a>running <span class="ot">&lt;-</span> cherry_blossom_sample <span class="sc">%&gt;%</span> </span>
<span id="cb1-4"><a href=""></a>  <span class="fu">select</span>(runner, age, net)</span>
<span id="cb1-5"><a href=""></a><span class="fu">glimpse</span>(running)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 252
Columns: 3
$ runner &lt;fct&gt; 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, …
$ age    &lt;int&gt; 53, 54, 55, 56, 57, 58, 59, 52, 53, 54, 55, 56, 58, 59, 51, 52,…
$ net    &lt;dbl&gt; 83.98333, 74.30000, 75.15000, 74.21667, 74.25000, NA, NA, 82.66…</code></pre>
</div>
</div>
</section>
<section id="section-1" class="slide level2">
<h2></h2>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href=""></a><span class="fu">ggplot</span>(running, <span class="fu">aes</span>(<span class="at">x =</span> runner, <span class="at">y =</span> net)) <span class="sc">+</span> </span>
<span id="cb3-2"><a href=""></a>  <span class="fu">geom_boxplot</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>

</div>
<img data-src="9b-hlm-nopred_files/figure-revealjs/unnamed-chunk-3-1.png" width="960" class="r-stretch"></section>
<section id="complete-pooling" class="slide level2">
<h2>Complete Pooling</h2>
<p>Complete pooling technique: combine all 252 observations across our 36 runners into one pool of information.</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href=""></a><span class="fu">ggplot</span>(running, <span class="fu">aes</span>(<span class="at">y =</span> net, <span class="at">x =</span> age)) <span class="sc">+</span> </span>
<span id="cb4-2"><a href=""></a>  <span class="fu">geom_point</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>

</div>
<img data-src="9b-hlm-nopred_files/figure-revealjs/unnamed-chunk-4-1.png" class="quarto-figure quarto-figure-center r-stretch" width="960"></section>
<section id="complete-pooling-1" class="slide level2">
<h2>Complete Pooling</h2>
<p><span class="math display">\[Y_i | \beta_0, \beta_1, \sigma \stackrel{ind}{\sim} N\left(\mu_i, \sigma^2\right) \;\; \text{ with } \;\; \mu_i = \beta_0 + \beta_1X_i\]</span></p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href=""></a>complete_pooled_model <span class="ot">&lt;-</span> <span class="fu">stan_glm</span>(</span>
<span id="cb5-2"><a href=""></a>  net <span class="sc">~</span> age, </span>
<span id="cb5-3"><a href=""></a>  <span class="at">data =</span> running, <span class="at">family =</span> gaussian, </span>
<span id="cb5-4"><a href=""></a>  <span class="at">prior_intercept =</span> <span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">2.5</span>, <span class="at">autoscale =</span> <span class="cn">TRUE</span>),</span>
<span id="cb5-5"><a href=""></a>  <span class="at">prior =</span> <span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">2.5</span>, <span class="at">autoscale =</span> <span class="cn">TRUE</span>), </span>
<span id="cb5-6"><a href=""></a>  <span class="at">prior_aux =</span> <span class="fu">exponential</span>(<span class="dv">1</span>, <span class="at">autoscale =</span> <span class="cn">TRUE</span>),</span>
<span id="cb5-7"><a href=""></a>  <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">iter =</span> <span class="dv">5000</span><span class="sc">*</span><span class="dv">2</span>, <span class="at">refresh =</span> <span class="dv">0</span>, <span class="at">seed =</span> <span class="dv">84735</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href=""></a><span class="fu">tidy</span>(complete_pooled_model, <span class="at">conf.int =</span> <span class="cn">TRUE</span>, <span class="at">conf.level =</span> <span class="fl">0.80</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 5
  term        estimate std.error conf.low conf.high
  &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
1 (Intercept)   75.2      24.6     43.7     106.   
2 age            0.268     0.446   -0.302     0.842</code></pre>
</div>
</div>
</section>
<section id="section-2" class="slide level2">
<h2></h2>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href=""></a><span class="co"># Plot of the posterior median model</span></span>
<span id="cb8-2"><a href=""></a><span class="fu">ggplot</span>(running, <span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> net, <span class="at">group =</span> runner)) <span class="sc">+</span> </span>
<span id="cb8-3"><a href=""></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"gray"</span>, <span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span> </span>
<span id="cb8-4"><a href=""></a>  <span class="fu">geom_abline</span>(<span class="fu">aes</span>(<span class="at">intercept =</span> <span class="fl">75.2</span>, <span class="at">slope =</span> <span class="fl">0.268</span>), <span class="at">color =</span> <span class="st">"blue"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>

</div>
<img data-src="9b-hlm-nopred_files/figure-revealjs/unnamed-chunk-7-1.png" width="960" class="r-stretch"></section>
<section id="section-3" class="slide level2">
<h2></h2>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href=""></a><span class="co"># Select an example subset</span></span>
<span id="cb9-2"><a href=""></a>examples <span class="ot">&lt;-</span> running <span class="sc">%&gt;%</span> </span>
<span id="cb9-3"><a href=""></a>  <span class="fu">filter</span>(runner <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"1"</span>, <span class="st">"20"</span>, <span class="st">"22"</span>))</span>
<span id="cb9-4"><a href=""></a></span>
<span id="cb9-5"><a href=""></a><span class="fu">ggplot</span>(examples, <span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> net)) <span class="sc">+</span> </span>
<span id="cb9-6"><a href=""></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb9-7"><a href=""></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> runner) <span class="sc">+</span> </span>
<span id="cb9-8"><a href=""></a>  <span class="fu">geom_abline</span>(<span class="fu">aes</span>(<span class="at">intercept =</span> <span class="fl">75.2242</span>, <span class="at">slope =</span> <span class="fl">0.2678</span>), </span>
<span id="cb9-9"><a href=""></a>              <span class="at">color =</span> <span class="st">"blue"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>

</div>
<img data-src="9b-hlm-nopred_files/figure-revealjs/unnamed-chunk-8-1.png" width="960" class="r-stretch"></section>
<section id="section-4" class="slide level2">
<h2></h2>
<ol type="1">
<li class="fragment">Though the observations on one runner might be independent of those on another, the observations <em>within</em> a runner are <em>correlated</em>. That is, how fast a runner ran in their previous race tells us something about how fast they’ll run in the next.</li>
<li class="fragment">With respect to the relationship between running time and age, people are inherently different.</li>
</ol>
</section>
<section id="section-5" class="slide level2">
<h2></h2>
<p>Framework of a complete pooled model:</p>

<img data-src="img/complete_pool_diagram.png" class="quarto-figure quarto-figure-center r-stretch" width="1920"><div class="fragment">
<p>Drawbacks of a complete pooling approach:</p>
<ol type="1">
<li class="fragment">we violate the assumption of independence; and, in turn,</li>
<li class="fragment">we might produce misleading conclusions about the relationship itself and the significance of this relationship.</li>
</ol>
</div>
</section>
<section id="no-pooling" class="slide level2">
<h2>No pooling</h2>

<img data-src="img/no_pool_diagram.png" style="width:50.0%" class="r-stretch"><div class="fragment">
<p>No pooling approach builds a <em>separate</em> model for each runner.</p>
</div>
<div class="fragment">
<p>Let <span class="math inline">\((Y_{ij}, X_{ij})\)</span> denote the observed run times and age for runner <span class="math inline">\(j\)</span> in their <span class="math inline">\(i\)</span>th race. Then the data structure for the Normal linear regression model of run time vs age for runner <span class="math inline">\(j\)</span> is:</p>
<p><span class="math display">\[Y_{ij} | \beta_{0j}, \beta_{1j}, \sigma \sim N\left(\mu_{ij}, \sigma^2\right) \;\; \text{ with } \;\; \mu_{ij} = \beta_{0j} + \beta_{1j} X_{ij}\]</span></p>
</div>
<div class="fragment">
<p>This model allows for each runner <span class="math inline">\(j\)</span> to have a unique intercept <span class="math inline">\(\beta_{0j}\)</span> and age coefficient <span class="math inline">\(\beta_{1j}\)</span>.</p>
</div>
</section>
<section id="section-6" class="slide level2">
<h2></h2>
<p>On the context of running, the no pooled models reflect the fact that some people tend to be faster than others (hence the different <span class="math inline">\(\beta_{0j}\)</span>) and that <em>changes</em> in speed over time aren’t the same for everyone (hence the different <span class="math inline">\(\beta_{1j}\)</span>).</p>
</section>
<section id="section-7" class="slide level2">
<h2></h2>

<img data-src="9b-hlm-nopred_files/figure-revealjs/unnamed-chunk-11-1.png" width="960" class="r-stretch"><p>Based on this model, what do you anticipate that your running time will be at the age of 55?</p>
</section>
<section id="section-8" class="slide level2">
<h2></h2>
<p>Drawbacks of a no pooling approach:</p>
<ul>
<li class="fragment">We cannot reliably generalize or apply the group-specific no pooled models to groups outside those in our sample.</li>
<li class="fragment">No pooled models assume that one group doesn’t contain relevant information about another, and thus ignores potentially valuable information. This is especially consequential when we have a small number of observations per group.</li>
</ul>
</section>
<section id="partial-pooling" class="slide level2">
<h2>Partial Pooling</h2>

<img data-src="img/partial_pool_diagram.png" style="width:70.0%" class="r-stretch"><p><strong>Examples</strong>: Students within classrooms, patients within hospitals, different runs for each runner (longitudunal, repeated-measures)</p>
</section>
<section id="within-group-variability" class="slide level2">
<h2>Within-group variability</h2>
<p>The degree of the variability among multiple observations <em>within</em> each group can be interesting on its own. For example, we can examine how <em>consistent</em> an <em>individual’s</em> running times are from year to year.</p>
<div class="fragment">
<p><strong>Between-group variability</strong></p>
<p>Hierarchical data also allows us to examine the variability from group to group. For example, we can examine the degree to which running patterns <em>vary</em> from individual to individual.</p>
</div>
</section>
<section id="section-9" class="slide level2">
<h2></h2>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href=""></a><span class="fu">data</span>(spotify)</span>
<span id="cb10-2"><a href=""></a></span>
<span id="cb10-3"><a href=""></a>spotify <span class="ot">&lt;-</span> spotify <span class="sc">%&gt;%</span> </span>
<span id="cb10-4"><a href=""></a>  <span class="fu">select</span>(artist, title, popularity) <span class="sc">%&gt;%</span> </span>
<span id="cb10-5"><a href=""></a>  <span class="fu">mutate</span>(<span class="at">artist =</span> <span class="fu">fct_reorder</span>(artist, popularity, <span class="at">.fun =</span> <span class="st">'mean'</span>))</span>
<span id="cb10-6"><a href=""></a></span>
<span id="cb10-7"><a href=""></a><span class="fu">glimpse</span>(spotify)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 350
Columns: 3
$ artist     &lt;fct&gt; Alok, Alok, Alok, Alok, Alok, Alok, Alok, Alok, Alok, Alok,…
$ title      &lt;chr&gt; "On &amp; On", "All The Lies", "Hear Me Now", "The Wall", "Hear…
$ popularity &lt;dbl&gt; 79, 56, 75, 65, 52, 45, 79, 61, 61, 61, 56, 71, 61, 79, 69,…</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href=""></a><span class="fu">nlevels</span>(spotify<span class="sc">$</span>artist)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 44</code></pre>
</div>
</div>
</section>
<section id="section-10" class="slide level2">
<h2></h2>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href=""></a>artist_means <span class="ot">&lt;-</span> spotify <span class="sc">%&gt;%</span> </span>
<span id="cb14-2"><a href=""></a>  <span class="fu">group_by</span>(artist) <span class="sc">%&gt;%</span> </span>
<span id="cb14-3"><a href=""></a>  <span class="fu">summarize</span>(<span class="at">count =</span> <span class="fu">n</span>(), <span class="at">popularity =</span> <span class="fu">mean</span>(popularity))</span>
<span id="cb14-4"><a href=""></a></span>
<span id="cb14-5"><a href=""></a>artist_means <span class="sc">%&gt;%</span></span>
<span id="cb14-6"><a href=""></a>  <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="dv">43</span><span class="sc">:</span><span class="dv">44</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 3
  artist        count popularity
  &lt;fct&gt;         &lt;int&gt;      &lt;dbl&gt;
1 Mia X             4       13.2
2 Chris Goldarg    10       16.4
3 Lil Skies         3       79.3
4 Camilo            9       81  </code></pre>
</div>
</div>
</section>
<section id="section-11" class="slide level2">
<h2></h2>

<img data-src="img/spotify-hierarchical-data-diagram.png" style="width:100.0%" class="r-stretch"></section>
<section id="section-12" class="slide level2">
<h2></h2>
<p><strong>Complete pooling</strong></p>
<p><em>Ignore</em> artists and lump all songs together</p>
<p><strong>No pooling</strong></p>
<p><em>Separately</em> analyze each artist and assume that one artist’s data doesn’t contain valuable information about another artist</p>
<p><strong>Partial pooling (via hierarchical models)</strong></p>
<p>Acknowledge the grouping structure, so that even though artists differ in popularity, they might share valuable information about each other <em>and</em> about the broader population of artists.</p>
</section>
<section id="the-hierarchy" class="slide level2">
<h2>The hierarchy</h2>
<p>Layer 1:</p>
<p><span class="math inline">\(Y_{ij} | \mu_j, \sigma_y   \hspace{-0.075in} \sim \text{model of how song popularity varies WITHIN artist } j\)</span></p>
<div class="fragment">
<p>Layer 2:</p>
<p><span class="math inline">\(\mu_j | \mu, \sigma_\mu  \hspace{-0.075in} \sim \text{model of how the typical popularity} \mu_j \text{varies BETWEEN artists}\)</span></p>
</div>
<div class="fragment">
<p>Layer 3:</p>
<p><span class="math inline">\(\mu, \sigma_y, \sigma_\mu   \hspace{-0.075in} \sim \text{prior models for shared global parameters}\)</span></p>
</div>
</section>
<section id="section-13" class="slide level2">
<h2></h2>
<ul>
<li class="fragment"><span class="math inline">\(\mu_j\)</span> = mean song popularity for artist <span class="math inline">\(j\)</span>; and</li>
<li class="fragment"><span class="math inline">\(\sigma_y\)</span> = <strong>within-group variability</strong>, i.e., the standard deviation in popularity from song to song within each artist.</li>
</ul>
</section>
<section id="section-14" class="slide level2">
<h2></h2>
<p>Popularity varies from artist to artist. We model this variability in mean popularity <strong>between</strong> artists by assuming that the individual mean popularity levels, <span class="math inline">\(\mu_j\)</span>, are <em>Normally</em> distributed around <span class="math inline">\(\mu\)</span> with standard deviation <span class="math inline">\(\sigma_\mu\)</span></p>
<p><span class="math display">\[\mu_j | \mu, \sigma_\mu \sim N(\mu, \sigma^2_\mu)  .\]</span></p>
<ul>
<li class="fragment"><span class="math inline">\(\mu\)</span> = the <strong>global average</strong> of mean song popularity <span class="math inline">\(\mu_j\)</span> across all artists <span class="math inline">\(j\)</span>, i.e., the mean popularity rating for the most average artist; and</li>
<li class="fragment"><span class="math inline">\(\sigma_\mu\)</span> = <strong>between-group variability</strong>, i.e., the standard deviation in mean popularity <span class="math inline">\(\mu_j\)</span> from artist to artist.</li>
</ul>
</section>
<section id="section-15" class="slide level2">
<h2></h2>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href=""></a><span class="fu">ggplot</span>(artist_means, <span class="fu">aes</span>(<span class="at">x =</span> popularity)) <span class="sc">+</span> </span>
<span id="cb16-2"><a href=""></a>  <span class="fu">geom_density</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>

</div>
<img data-src="9b-hlm-nopred_files/figure-revealjs/unnamed-chunk-16-1.png" width="960" class="r-stretch"></section>
<section id="section-16" class="slide level2">
<h2></h2>
<p><strong>Notation alert</strong></p>
<ul>
<li class="fragment"><p>There’s a difference between <span class="math inline">\(\mu_j\)</span> and <span class="math inline">\(\mu\)</span>. When a parameter has a subscript <span class="math inline">\(j\)</span>, it refers to a feature of group <span class="math inline">\(j\)</span>. When a parameter <em>doesn’t</em> have a subscript <span class="math inline">\(j\)</span>, it’s the <em>global</em> counterpart, i.e., the same feature across all groups.</p></li>
<li class="fragment"><p>Subscripts signal the group or layer of interest. For example, <span class="math inline">\(\sigma_y\)</span> refers to the standard deviation of <span class="math inline">\(Y\)</span> values within each group, whereas <span class="math inline">\(\sigma_\mu\)</span> refers to the standard deviation of means <span class="math inline">\(\mu_j\)</span> from group to group.</p></li>
</ul>
</section>
<section id="section-17" class="slide level2">
<h2></h2>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href=""></a>spotify_hierarchical <span class="ot">&lt;-</span> <span class="fu">stan_glmer</span>(</span>
<span id="cb17-2"><a href=""></a>  popularity <span class="sc">~</span> (<span class="dv">1</span> <span class="sc">|</span> artist), </span>
<span id="cb17-3"><a href=""></a>  <span class="at">data =</span> spotify, <span class="at">family =</span> gaussian,</span>
<span id="cb17-4"><a href=""></a>  <span class="at">prior_intercept =</span> <span class="fu">normal</span>(<span class="dv">50</span>, <span class="fl">2.5</span>, <span class="at">autoscale =</span> <span class="cn">TRUE</span>),</span>
<span id="cb17-5"><a href=""></a>  <span class="at">prior_aux =</span> <span class="fu">exponential</span>(<span class="dv">1</span>, <span class="at">autoscale =</span> <span class="cn">TRUE</span>),</span>
<span id="cb17-6"><a href=""></a>  <span class="at">prior_covariance =</span> <span class="fu">decov</span>(<span class="at">reg =</span> <span class="dv">1</span>, <span class="at">conc =</span> <span class="dv">1</span>, <span class="at">shape =</span> <span class="dv">1</span>, <span class="at">scale =</span> <span class="dv">1</span>),</span>
<span id="cb17-7"><a href=""></a>  <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">iter =</span> <span class="dv">5000</span><span class="sc">*</span><span class="dv">2</span>, <span class="at">seed =</span> <span class="dv">84735</span>, <span class="at">refresh=</span><span class="cn">FALSE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<ul>
<li class="fragment">To indicate that the <code>artist</code> variable defines the group structure of our data, as opposed to it being a predictor of <code>popularity</code>, the appropriate formula here is <code>popularity ~ (1 | artist)</code>.</li>
<li class="fragment">The prior for <span class="math inline">\(\sigma_\mu\)</span> is specified by <code>prior_covariance</code>. For this particular model, with only one set of artist-specific parameters <span class="math inline">\(\mu_j\)</span>, this is equivalent to an Exp(1) prior. (We will learn more about <code>prior_covariance</code> next lecture).</li>
</ul>
</section>
<section id="section-18" class="slide level2">
<h2></h2>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href=""></a><span class="fu">pp_check</span>(spotify_hierarchical) <span class="sc">+</span> </span>
<span id="cb18-2"><a href=""></a>  <span class="fu">xlab</span>(<span class="st">"popularity"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>

</div>
<img data-src="9b-hlm-nopred_files/figure-revealjs/unnamed-chunk-18-1.png" width="960" class="r-stretch"></section>
<section id="section-19" class="slide level2">
<h2></h2>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href=""></a><span class="co"># Store the simulation in a data frame</span></span>
<span id="cb19-2"><a href=""></a>spotify_hierarchical_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(spotify_hierarchical)</span>
<span id="cb19-3"><a href=""></a></span>
<span id="cb19-4"><a href=""></a><span class="co"># Check out the first 3 and last 3 parameter labels</span></span>
<span id="cb19-5"><a href=""></a>spotify_hierarchical_df <span class="sc">%&gt;%</span> </span>
<span id="cb19-6"><a href=""></a>  <span class="fu">colnames</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb19-7"><a href=""></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb19-8"><a href=""></a>  <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="dv">45</span><span class="sc">:</span><span class="dv">47</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                      .
1                           (Intercept)
2           b[(Intercept) artist:Mia_X]
3   b[(Intercept) artist:Chris_Goldarg]
4          b[(Intercept) artist:Camilo]
5                                 sigma
6 Sigma[artist:(Intercept),(Intercept)]</code></pre>
</div>
</div>
</section>
<section id="posterior-analysis-of-global-parameters" class="slide level2">
<h2>Posterior Analysis of Global Parameters</h2>
<ul>
<li class="fragment"><span class="math inline">\(\mu\)</span> = <code>(Intercept)</code></li>
<li class="fragment"><span class="math inline">\(\sigma_y\)</span> = <code>sigma</code></li>
<li class="fragment"><span class="math inline">\(\sigma_\mu^2\)</span> = <code>Sigma[artist:(Intercept),(Intercept)]</code>.This is not a typo. The default output gives us information about the <em>standard deviation</em> within artists ( <span class="math inline">\(\sigma_y\)</span> ) but the <em>variance</em> between artists ( <span class="math inline">\(\sigma_\mu^2\)</span> ).</li>
</ul>
</section>
<section id="section-20" class="slide level2">
<h2></h2>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href=""></a><span class="fu">tidy</span>(spotify_hierarchical, <span class="at">effects =</span> <span class="st">"fixed"</span>, </span>
<span id="cb21-2"><a href=""></a>     <span class="at">conf.int =</span> <span class="cn">TRUE</span>, <span class="at">conf.level =</span> <span class="fl">0.80</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 5
  term        estimate std.error conf.low conf.high
  &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
1 (Intercept)     52.4      2.48     49.2      55.6</code></pre>
</div>
</div>
<p>Pay attention to <code>effects = fixed</code>, where “fixed” is synonymous with “non-varying” or “global.”</p>
<p>Per the results, there’s an 80% chance that the <em>average</em> artist has a mean popularity rating between 49.2 and 55.6.</p>
</section>
<section id="section-21" class="slide level2">
<h2></h2>
<p>To call up the posterior medians for <span class="math inline">\(\sigma_y\)</span> and <span class="math inline">\(\sigma_\mu\)</span>, we can specify <code>effects = "ran_pars"</code>, i.e., <code>par</code>ameters related to <code>ran</code>domness or variability:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href=""></a><span class="fu">tidy</span>(spotify_hierarchical, <span class="at">effects =</span> <span class="st">"ran_pars"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 3
  term                    group    estimate
  &lt;chr&gt;                   &lt;chr&gt;       &lt;dbl&gt;
1 sd_(Intercept).artist   artist       15.2
2 sd_Observation.Residual Residual     14.0</code></pre>
</div>
</div>
<p>The posterior median of <span class="math inline">\(\sigma_y\)</span> (<code>sd_Obervation.Residual</code>) suggests that, <em>within</em> any given artist, popularity ratings tend to vary by 14 points <em>from song to song</em>. The <em>between</em> standard deviation <span class="math inline">\(\sigma_\mu\)</span> (<code>sd_(Intercept).artist</code>) tends to be slightly higher at around 15.2. Thus, the <em>mean</em> popularity rating tends to vary by 15.2 points <em>from artist to artist</em>.</p>
</section>
<section id="section-22" class="slide level2">
<h2></h2>
<p>proportion of <span class="math inline">\(\text{Var}(Y_{ij})\)</span> that can be explained by differences in the observations within each group:</p>
<p><span class="math display">\[\frac{\sigma^2_y}{\sigma^2_\mu + \sigma^2_y}\]</span></p>
<hr>
<p>proportion of <span class="math inline">\(\text{Var}(Y_{ij})\)</span>that can be explained by differences between groups</p>
<p><span class="math display">\[\frac{\sigma^2_\mu}{\sigma^2_\mu + \sigma^2_y}\]</span></p>
</section>
<section id="section-23" class="slide level2">
<h2></h2>
<p>These two sources of variability suggest that the popularity levels among multiple songs <em>by the same artist</em> tend to have a moderate correlation near 0.54.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href=""></a><span class="fl">15.1</span><span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> (<span class="fl">15.1</span><span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> <span class="fl">14.0</span><span class="sc">^</span><span class="dv">2</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.5377468</code></pre>
</div>
</div>
<div class="fragment">
<p>Thinking of this another way, 54% of the variability in song popularity is explained by differences between artists, whereas 46% is explained by differences among the songs within each artist:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href=""></a><span class="fl">14.0</span><span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> (<span class="fl">15.1</span><span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> <span class="fl">14.0</span><span class="sc">^</span><span class="dv">2</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.4622532</code></pre>
</div>
</div>
</div>
</section>
<section id="posterior-analysis-of-group-specific-parameters" class="slide level2">
<h2>Posterior analysis of group-specific parameters</h2>
<p><span class="math display">\[\mu_j = \mu + b_j \]</span></p>
<p>Here, <span class="math inline">\(b_j\)</span> describes the <em>difference</em> between artist <span class="math inline">\(j\)</span>’s mean popularity and the global mean popularity.</p>
</section>
<section id="section-24" class="slide level2">
<h2></h2>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href=""></a>artist_summary <span class="ot">&lt;-</span> <span class="fu">tidy</span>(spotify_hierarchical, <span class="at">effects =</span> <span class="st">"ran_vals"</span>, </span>
<span id="cb29-2"><a href=""></a>                       <span class="at">conf.int =</span> <span class="cn">TRUE</span>, <span class="at">conf.level =</span> <span class="fl">0.80</span>)</span>
<span id="cb29-3"><a href=""></a><span class="co"># Check out the results for the first &amp; last 2 artists</span></span>
<span id="cb29-4"><a href=""></a>artist_summary <span class="sc">%&gt;%</span> </span>
<span id="cb29-5"><a href=""></a>  <span class="fu">select</span>(level, conf.low, conf.high) <span class="sc">%&gt;%</span> </span>
<span id="cb29-6"><a href=""></a>  <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="dv">43</span><span class="sc">:</span><span class="dv">44</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 3
  level         conf.low conf.high
  &lt;chr&gt;            &lt;dbl&gt;     &lt;dbl&gt;
1 Mia_X            -40.8     -23.1
2 Chris_Goldarg    -39.3     -26.7
3 Lil_Skies         11.1      30.4
4 Camilo            19.5      32.6</code></pre>
</div>
</div>
</section>
<section id="section-25" class="slide level2">
<h2></h2>
<p>There’s an 80% chance that <code>Camilo</code>’s mean popularity rating is between 19.5 and 32.6 <em>above</em> that of the average artist.</p>
<div class="fragment">
<p><span class="math display">\[\mu_j = \mu + b_j = \text{(Intercept) + b[(Intercept) artist:j]} .\]</span></p>
</div>
</section>
<section id="section-26" class="slide level2">
<h2></h2>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href=""></a><span class="co"># Get MCMC chains for each mu_j</span></span>
<span id="cb31-2"><a href=""></a>artist_chains <span class="ot">&lt;-</span> spotify_hierarchical <span class="sc">%&gt;%</span></span>
<span id="cb31-3"><a href=""></a>  tidybayes<span class="sc">::</span><span class="fu">spread_draws</span>(<span class="st">`</span><span class="at">(Intercept)</span><span class="st">`</span>, b[,artist]) <span class="sc">%&gt;%</span> </span>
<span id="cb31-4"><a href=""></a>  <span class="fu">mutate</span>(<span class="at">mu_j =</span> <span class="st">`</span><span class="at">(Intercept)</span><span class="st">`</span> <span class="sc">+</span> b) </span>
<span id="cb31-5"><a href=""></a><span class="co"># Check it out</span></span>
<span id="cb31-6"><a href=""></a>artist_chains <span class="sc">%&gt;%</span> </span>
<span id="cb31-7"><a href=""></a>  <span class="fu">select</span>(artist, <span class="st">`</span><span class="at">(Intercept)</span><span class="st">`</span>, b, mu_j) <span class="sc">%&gt;%</span> </span>
<span id="cb31-8"><a href=""></a>  <span class="fu">head</span>(<span class="dv">4</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 4
# Groups:   artist [4]
  artist              `(Intercept)`     b  mu_j
  &lt;chr&gt;                       &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1 artist:Alok                  50.1 11.4   61.5
2 artist:Atlas_Genius          50.1 -9.81  40.2
3 artist:Au/Ra                 50.1 12.3   62.4
4 artist:Beyoncé               50.1 22.2   72.3</code></pre>
</div>
</div>
</section>
<section id="section-27" class="slide level2">
<h2></h2>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href=""></a><span class="co"># Get posterior summaries for mu_j</span></span>
<span id="cb33-2"><a href=""></a>artist_summary_scaled <span class="ot">&lt;-</span> artist_chains <span class="sc">%&gt;%</span> </span>
<span id="cb33-3"><a href=""></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="st">`</span><span class="at">(Intercept)</span><span class="st">`</span>, <span class="sc">-</span>b) <span class="sc">%&gt;%</span> </span>
<span id="cb33-4"><a href=""></a>  tidybayes<span class="sc">::</span><span class="fu">mean_qi</span>(<span class="at">.width =</span> <span class="fl">0.80</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb33-5"><a href=""></a>  <span class="fu">mutate</span>(<span class="at">artist =</span> <span class="fu">fct_reorder</span>(artist, mu_j))</span>
<span id="cb33-6"><a href=""></a></span>
<span id="cb33-7"><a href=""></a><span class="co"># Check out the results</span></span>
<span id="cb33-8"><a href=""></a>artist_summary_scaled <span class="sc">%&gt;%</span> </span>
<span id="cb33-9"><a href=""></a>  <span class="fu">select</span>(artist, mu_j, .lower, .upper) <span class="sc">%&gt;%</span> </span>
<span id="cb33-10"><a href=""></a>  <span class="fu">head</span>(<span class="dv">4</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 4
  artist               mu_j .lower .upper
  &lt;fct&gt;               &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
1 artist:Alok          64.3   60.2   68.3
2 artist:Atlas_Genius  47.0   38.9   55.1
3 artist:Au/Ra         59.5   52.0   67.1
4 artist:Beyoncé       69.1   65.5   72.7</code></pre>
</div>
</div>
</section>
<section id="section-28" class="slide level2">
<h2></h2>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href=""></a><span class="fu">ggplot</span>(artist_summary_scaled, </span>
<span id="cb35-2"><a href=""></a>       <span class="fu">aes</span>(<span class="at">x =</span> artist, <span class="at">y =</span> mu_j, <span class="at">ymin =</span> .lower, <span class="at">ymax =</span> .upper)) <span class="sc">+</span></span>
<span id="cb35-3"><a href=""></a>  <span class="fu">geom_pointrange</span>() <span class="sc">+</span></span>
<span id="cb35-4"><a href=""></a>  <span class="fu">xaxis_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">hjust =</span> <span class="dv">1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>

</div>
<img data-src="9b-hlm-nopred_files/figure-revealjs/unnamed-chunk-31-1.png" class="quarto-figure quarto-figure-center r-stretch" style="width:40.0%"></section>
<section id="section-29" class="slide level2">
<h2></h2>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href=""></a>artist_means <span class="sc">%&gt;%</span> </span>
<span id="cb36-2"><a href=""></a>  <span class="fu">filter</span>(artist <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Frank Ocean"</span>, <span class="st">"Lil Skies"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 3
  artist      count popularity
  &lt;fct&gt;       &lt;int&gt;      &lt;dbl&gt;
1 Frank Ocean    40       69.8
2 Lil Skies       3       79.3</code></pre>
</div>
</div>
<p>Our posterior understanding of Frank Ocean is based on 40 songs, the most of any artist in the dataset, we have only 3 songs for Lil Skies. We naturally have greater posterior certainty about Frank Ocean’s popularity, and hence narrower intervals.</p>
</section>
<section id="posterior-prediction" class="slide level2">
<h2>Posterior Prediction</h2>
<p>First consider the <strong>posterior prediction for an observed group</strong> or artist, Frank Ocean, the <span class="math inline">\(j\)</span> = 39th artist in our sample.</p>
<div class="fragment">
<p>The first layer of our hierarchical model holds the key in this situation: it assumes that the popularity of individual Frank Ocean songs are Normally distributed around his own mean popularity level <span class="math inline">\(\mu_j\)</span> with standard deviation <span class="math inline">\(\sigma_y\)</span>.</p>
</div>
<div class="fragment">
<p>Thus, to approximate the posterior predictive model for the popularity of Ocean’s <em>next</em> song on Spotify, we can simulate a prediction from the Layer 1 model evaluated at each of the 20,000 MCMC parameter sets <span class="math inline">\(\left\lbrace \mu_j^{(i)}, \sigma_y^{(i)}\right\rbrace\)</span>:</p>
<p><span class="math display">\[\begin{equation}
Y_{\text{new,j}}^{(i)} | \mu_j, \sigma_y  \; \sim \; N\left(\mu_j^{(i)}, \left(\sigma_y^{(i)}\right)^2\right).
\end{equation}\]</span></p>
</div>
</section>
<section id="section-30" class="slide level2">
<h2></h2>
<p>The resulting predictions <span class="math inline">\(\left\lbrace Y_{\text{new},j}^{(1)}, Y_{\text{new},j}^{(2)}, \ldots, Y_{\text{new},j}^{(20000)} \right\rbrace\)</span> and corresponding posterior predictive model will reflect two sources of variability, and hence uncertainty, in the popularity of Ocean’s next song:</p>
<ul>
<li class="fragment"><p><strong>within-group sampling variability</strong> in <span class="math inline">\(Y\)</span>, i.e., not all of Ocean’s songs are equally popular; and</p></li>
<li class="fragment"><p><strong>posterior variability</strong> in the model parameters <span class="math inline">\(\mu_j\)</span> and <span class="math inline">\(\sigma_y\)</span>, i.e., the underlying mean and variability in popularity across Ocean’s songs are unknown and can, themselves, vary.</p></li>
</ul>
</section>
<section id="section-31" class="slide level2">
<h2></h2>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href=""></a><span class="co"># Simulate Ocean's posterior predictive model</span></span>
<span id="cb38-2"><a href=""></a><span class="fu">set.seed</span>(<span class="dv">84735</span>)</span>
<span id="cb38-3"><a href=""></a>ocean_chains <span class="ot">&lt;-</span> spotify_hierarchical_df <span class="sc">%&gt;%</span></span>
<span id="cb38-4"><a href=""></a>  <span class="fu">rename</span>(<span class="at">b =</span> <span class="st">`</span><span class="at">b[(Intercept) artist:Frank_Ocean]</span><span class="st">`</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb38-5"><a href=""></a>  <span class="fu">select</span>(<span class="st">`</span><span class="at">(Intercept)</span><span class="st">`</span>, b, sigma) <span class="sc">%&gt;%</span> </span>
<span id="cb38-6"><a href=""></a>  <span class="fu">mutate</span>(<span class="at">mu_ocean =</span> <span class="st">`</span><span class="at">(Intercept)</span><span class="st">`</span> <span class="sc">+</span> b,</span>
<span id="cb38-7"><a href=""></a>         <span class="at">y_ocean =</span> <span class="fu">rnorm</span>(<span class="dv">20000</span>, <span class="at">mean =</span> mu_ocean, <span class="at">sd =</span> sigma))</span>
<span id="cb38-8"><a href=""></a></span>
<span id="cb38-9"><a href=""></a><span class="co"># Check it out</span></span>
<span id="cb38-10"><a href=""></a><span class="fu">head</span>(ocean_chains, <span class="dv">3</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  (Intercept)        b    sigma mu_ocean  y_ocean
1    50.05874 18.01862 13.53963 68.07736 77.11144
2    53.35882 17.93030 13.36078 71.28912 69.63452
3    51.43166 15.88972 14.78483 67.32138 78.86637</code></pre>
</div>
</div>
</section>
<section id="section-32" class="slide level2">
<h2></h2>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href=""></a><span class="co"># Posterior summary of Y_new,j</span></span>
<span id="cb40-2"><a href=""></a>ocean_chains <span class="sc">%&gt;%</span> </span>
<span id="cb40-3"><a href=""></a>  tidybayes<span class="sc">::</span><span class="fu">mean_qi</span>(y_ocean, <span class="at">.width =</span> <span class="fl">0.80</span>) </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 6
  y_ocean .lower .upper .width .point .interval
    &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    
1    69.4   51.3   87.4    0.8 mean   qi       </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb42"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href=""></a><span class="co"># Posterior summary of mu_j</span></span>
<span id="cb42-2"><a href=""></a>artist_summary_scaled <span class="sc">%&gt;%</span> </span>
<span id="cb42-3"><a href=""></a>  <span class="fu">filter</span>(artist <span class="sc">==</span> <span class="st">"artist:Frank_Ocean"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 7
  artist              mu_j .lower .upper .width .point .interval
  &lt;fct&gt;              &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    
1 artist:Frank_Ocean  69.4   66.5   72.2    0.8 mean   qi       </code></pre>
</div>
</div>
</section>
<section id="section-33" class="slide level2">
<h2></h2>
<p>Next consider <strong>posterior prediction for a yet unobserved group</strong>, Mohsen Beats.</p>
<div class="fragment">
<p>No observed songs for Mohsen Beats means that we do <em>not</em> have any information about their mean popularity <span class="math inline">\(\mu_j\)</span>, and thus can’t take the same approach as we did for Ocean.</p>
</div>
</section>
<section id="section-34" class="slide level2">
<h2></h2>
<p>What we <em>do</em> know is this: (1) Mohsen Beats is an artist within the broader population of artists, (2) mean popularity levels among these artists are Normally distributed around some global mean <span class="math inline">\(\mu\)</span> with between-artist standard deviation <span class="math inline">\(\sigma_\mu\)</span> (Layer 2), and (3) our 44 sampled artists have informed our posterior understanding of this broader population. Then to approximate the posterior predictive model for the popularity of Mohsen Beats’ next song, we can simulate 20,000 predictions <span class="math inline">\(\left\lbrace Y_{\text{new},\text{mohsen}}^{(1)}, Y_{\text{new},\text{mohsen}}^{(2)}, \ldots, Y_{\text{new},\text{mohsen}}^{(20000)} \right\rbrace\)</span> through a two-step process:</p>
</section>
<section id="section-35" class="slide level2">
<h2></h2>
<ul>
<li class="fragment"><p><strong>Step 1:</strong> Simulate a potential <em>mean</em> popularity level <span class="math inline">\(\mu_{\text{mohsen}}\)</span> for Mohsen Beats by drawing from the Layer 2 model evaluated at each MCMC parameter set <span class="math inline">\(\left\lbrace \mu^{(i)}, \sigma_\mu^{(i)}\right\rbrace\)</span>:</p>
<p><span class="math display">\[\mu_{\text{mohsen}}^{(i)} | \mu, \sigma_\mu  \; \sim \; N\left(\mu^{(i)}, \left(\sigma_\mu^{(i)}\right)^2\right).\]</span></p></li>
</ul>
<div class="fragment">
<ul>
<li class="fragment"><p><strong>Step 2:</strong> Simulate a prediction of song popularity <span class="math inline">\(Y_{\text{new},\text{mohsen}}\)</span> from the Layer 1 model evaluated at each MCMC parameter set <span class="math inline">\(\left\lbrace \mu_{\text{mohsen}}^{(i)}, \sigma_y^{(i)}\right\rbrace\)</span>:</p>
<p><span class="math display">\[Y_{\text{new},\text{mohsen}}^{(i)} | \mu_{\text{mohsen}}, \sigma_y  \; \sim \; N\left(\mu_{\text{mohsen}}^{(i)}, \left(\sigma_y^{(i)}\right)^2\right).\]</span></p></li>
</ul>
</div>
</section>
<section id="section-36" class="slide level2">
<h2></h2>
<p>The additional step in our Mohsen Beats posterior prediction process reflects a <em>third</em> source of variability. When predicting song popularity for a new group, we must account for:</p>
<ul>
<li class="fragment"><p><strong>within-group sampling variability</strong> in <span class="math inline">\(Y\)</span>, i.e., not all of Mohsen Beats’ <em>songs</em> are equally popular;</p></li>
<li class="fragment"><p><strong>between-group sampling variability</strong> in <span class="math inline">\(\mu_j\)</span>, i.e., not all <em>artists</em> are equally popular; and</p></li>
<li class="fragment"><p><strong>posterior variability</strong> in the global model parameters <span class="math inline">\((\sigma_y, \mu, \sigma_\mu)\)</span>.</p></li>
</ul>
</section>
<section id="section-37" class="slide level2">
<h2></h2>
<p>We’re able to predict with 80% posterior certainty that their next song will have a popularity rating somewhere between 25.66 and 78.6:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href=""></a><span class="fu">set.seed</span>(<span class="dv">84735</span>)</span>
<span id="cb44-2"><a href=""></a>mohsen_chains <span class="ot">&lt;-</span> spotify_hierarchical_df <span class="sc">%&gt;%</span></span>
<span id="cb44-3"><a href=""></a>  <span class="fu">mutate</span>(<span class="at">sigma_mu =</span> <span class="fu">sqrt</span>(<span class="st">`</span><span class="at">Sigma[artist:(Intercept),(Intercept)]</span><span class="st">`</span>),</span>
<span id="cb44-4"><a href=""></a>         <span class="at">mu_mohsen =</span> <span class="fu">rnorm</span>(<span class="dv">20000</span>, <span class="st">`</span><span class="at">(Intercept)</span><span class="st">`</span>, sigma_mu),</span>
<span id="cb44-5"><a href=""></a>         <span class="at">y_mohsen =</span> <span class="fu">rnorm</span>(<span class="dv">20000</span>, mu_mohsen, sigma))</span>
<span id="cb44-6"><a href=""></a><span class="co"># Posterior predictive summaries</span></span>
<span id="cb44-7"><a href=""></a>mohsen_chains <span class="sc">%&gt;%</span> </span>
<span id="cb44-8"><a href=""></a>  <span class="fu">mean_qi</span>(y_mohsen, <span class="at">.width =</span> <span class="fl">0.80</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 6
  y_mohsen .lower .upper .width .point .interval
     &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;    
1     52.2   25.7   78.6    0.8 mean   qi       </code></pre>
</div>
</div>
</section>
<section id="section-38" class="slide level2">
<h2></h2>
<p>We can replicate the “by hand” simulations for Frank Ocean and Mohsen Beats using the <code>posterior_predict()</code> shortcut function.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href=""></a><span class="fu">set.seed</span>(<span class="dv">84735</span>)</span>
<span id="cb46-2"><a href=""></a>prediction_shortcut <span class="ot">&lt;-</span> <span class="fu">posterior_predict</span>(</span>
<span id="cb46-3"><a href=""></a>  spotify_hierarchical,</span>
<span id="cb46-4"><a href=""></a>  <span class="at">newdata =</span> <span class="fu">data.frame</span>(<span class="at">artist =</span> <span class="fu">c</span>(<span class="st">"Frank Ocean"</span>, <span class="st">"Mohsen Beats"</span>)))</span>
<span id="cb46-5"><a href=""></a><span class="co"># Posterior predictive model plots</span></span>
<span id="cb46-6"><a href=""></a><span class="fu">mcmc_areas</span>(prediction_shortcut, <span class="at">prob =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb46-7"><a href=""></a>  ggplot2<span class="sc">::</span><span class="fu">scale_y_discrete</span>(<span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Frank Ocean"</span>, <span class="st">"Mohsen Beats"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>

</div>
<img data-src="9b-hlm-nopred_files/figure-revealjs/unnamed-chunk-37-1.png" width="384" class="r-stretch"></section>
<section id="section-39" class="slide level2">
<h2></h2>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href=""></a><span class="fu">set.seed</span>(<span class="dv">84735</span>)</span>
<span id="cb47-2"><a href=""></a>predictions_hierarchical <span class="ot">&lt;-</span> <span class="fu">posterior_predict</span>(spotify_hierarchical, </span>
<span id="cb47-3"><a href=""></a>                                              <span class="at">newdata =</span> artist_means)</span>
<span id="cb47-4"><a href=""></a></span>
<span id="cb47-5"><a href=""></a><span class="co"># Posterior predictive plots</span></span>
<span id="cb47-6"><a href=""></a><span class="fu">ppc_intervals</span>(artist_means<span class="sc">$</span>popularity, <span class="at">yrep =</span> predictions_hierarchical, </span>
<span id="cb47-7"><a href=""></a>              <span class="at">prob_outer =</span> <span class="fl">0.80</span>) <span class="sc">+</span></span>
<span id="cb47-8"><a href=""></a>  ggplot2<span class="sc">::</span><span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> artist_means<span class="sc">$</span>artist, </span>
<span id="cb47-9"><a href=""></a>                              <span class="at">breaks =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(artist_means)) <span class="sc">+</span></span>
<span id="cb47-10"><a href=""></a>  <span class="fu">xaxis_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">hjust =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb47-11"><a href=""></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fl">58.4</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="section-40" class="slide level2">
<h2></h2>

<img data-src="9b-hlm-nopred_files/figure-revealjs/unnamed-chunk-39-1.png" width="960" class="r-stretch"></section>
<section id="section-41" class="slide level2">
<h2></h2>
<p><strong>Shrinkage</strong> refers to the phenomenon in which the group-specific local trends in a hierarchical model are pulled or <em>shrunk</em> toward the global trends.</p>
<p>When utilizing weakly informative priors, the posterior mean predictions of song popularity from the hierarchical model are (roughly) weighted averages of those from the complete pooled ( <span class="math inline">\(\overline{y}_{\text{global}}\)</span> ) and no pooled ( <span class="math inline">\(\overline{y}_j\)</span> ) models:</p>
<p><span class="math display">\[\frac{\sigma^2_y}{\sigma^2_y + n_j \sigma^2_\mu} \overline{y}_{\text{global}} + \frac{n_j\sigma^2_\mu}{\sigma^2_y + n_j \sigma^2_\mu} \overline{y}_j\]</span></p>
</section>
<section id="section-42" class="slide level2">
<h2></h2>
<p>In posterior predictions for artist <span class="math inline">\(j\)</span>, the <em>weights</em> given to the global and local means depend upon how much data we have on artist <span class="math inline">\(j\)</span> ( <span class="math inline">\(n_j\)</span> ) as well as the comparison of the <em>within</em>-group and <em>between</em>-group variability in song popularity ( <span class="math inline">\(\sigma_y\)</span> and <span class="math inline">\(\sigma_\mu\)</span> ). These weights highlight a couple of scenarios in which individualism fades, i.e., our hierarchical posterior predictions shrink away from the group-specific means <span class="math inline">\(\overline{y}_j\)</span> and toward the global mean <span class="math inline">\(\overline{y}_\text{global}\)</span>:</p>
</section>
<section id="section-43" class="slide level2">
<h2></h2>
<ul>
<li class="fragment"><p>Shrinkage increases as the number of observations on group <span class="math inline">\(j\)</span>, <span class="math inline">\(n_j\)</span>, decreases. That is, we rely more and more on global trends to understand a group for which we have little data.</p></li>
<li class="fragment"><p>Shrinkage increases when the variability within groups, <span class="math inline">\(\sigma_y\)</span>, is large in comparison to the variability between groups, <span class="math inline">\(\sigma_\mu\)</span>. That is, we rely more and more on global trends to understand a group when there is little distinction in the patterns from one group to the next.</p></li>
</ul>

</section>
    </div>
  <div class="quarto-auto-generated-content" style="display: none;">
<p><img src="https://www.stats115.com/img/logo.png" class="slide-logo"></p>
<div class="footer footer-default">
<p><a href="https://stats115.com">stats115.com</a></p>
</div>
</div></div>

  <script>window.backupDefine = window.define; window.define = undefined;</script>
  <script src="9b-hlm-nopred_files/libs/revealjs/dist/reveal.js"></script>
  <!-- reveal.js plugins -->
  <script src="9b-hlm-nopred_files/libs/revealjs/plugin/quarto-line-highlight/line-highlight.js"></script>
  <script src="9b-hlm-nopred_files/libs/revealjs/plugin/pdf-export/pdfexport.js"></script>
  <script src="9b-hlm-nopred_files/libs/revealjs/plugin/reveal-menu/menu.js"></script>
  <script src="9b-hlm-nopred_files/libs/revealjs/plugin/reveal-menu/quarto-menu.js"></script>
  <script src="9b-hlm-nopred_files/libs/revealjs/plugin/quarto-support/support.js"></script>
  

  <script src="9b-hlm-nopred_files/libs/revealjs/plugin/notes/notes.js"></script>
  <script src="9b-hlm-nopred_files/libs/revealjs/plugin/search/search.js"></script>
  <script src="9b-hlm-nopred_files/libs/revealjs/plugin/zoom/zoom.js"></script>
  <script src="9b-hlm-nopred_files/libs/revealjs/plugin/math/math.js"></script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script>

  <script>

      // Full list of configuration options available at:
      // https://revealjs.com/config/
      Reveal.initialize({
'controlsAuto': true,
'previewLinksAuto': false,
'pdfSeparateFragments': false,
'autoAnimateEasing': "ease",
'autoAnimateDuration': 1,
'autoAnimateUnmatched': true,
'jumpToSlide': true,
'menu': {"side":"left","useTextContentForMissingTitles":true,"markers":false,"loadIcons":false,"custom":[{"title":"Tools","icon":"<i class=\"fas fa-gear\"></i>","content":"<ul class=\"slide-menu-items\">\n<li class=\"slide-tool-item active\" data-item=\"0\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.fullscreen(event)\"><kbd>f</kbd> Fullscreen</a></li>\n<li class=\"slide-tool-item\" data-item=\"1\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.speakerMode(event)\"><kbd>s</kbd> Speaker View</a></li>\n<li class=\"slide-tool-item\" data-item=\"2\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.overview(event)\"><kbd>o</kbd> Slide Overview</a></li>\n<li class=\"slide-tool-item\" data-item=\"3\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.togglePdfExport(event)\"><kbd>e</kbd> PDF Export Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"4\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleScrollView(event)\"><kbd>r</kbd> Scroll View Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"5\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.keyboardHelp(event)\"><kbd>?</kbd> Keyboard Help</a></li>\n</ul>"}],"openButton":true},
'smaller': false,
 
        // Display controls in the bottom right corner
        controls: false,

        // Help the user learn the controls by providing hints, for example by
        // bouncing the down arrow when they first encounter a vertical slide
        controlsTutorial: false,

        // Determines where controls appear, "edges" or "bottom-right"
        controlsLayout: 'edges',

        // Visibility rule for backwards navigation arrows; "faded", "hidden"
        // or "visible"
        controlsBackArrows: 'faded',

        // Display a presentation progress bar
        progress: true,

        // Display the page number of the current slide
        slideNumber: 'c/t',

        // 'all', 'print', or 'speaker'
        showSlideNumber: 'all',

        // Add the current slide number to the URL hash so that reloading the
        // page/copying the URL will return you to the same slide
        hash: true,

        // Start with 1 for the hash rather than 0
        hashOneBasedIndex: false,

        // Flags if we should monitor the hash and change slides accordingly
        respondToHashChanges: true,

        // Push each slide change to the browser history
        history: true,

        // Enable keyboard shortcuts for navigation
        keyboard: true,

        // Enable the slide overview mode
        overview: true,

        // Disables the default reveal.js slide layout (scaling and centering)
        // so that you can use custom CSS layout
        disableLayout: false,

        // Vertical centering of slides
        center: false,

        // Enables touch navigation on devices with touch input
        touch: true,

        // Loop the presentation
        loop: false,

        // Change the presentation direction to be RTL
        rtl: false,

        // see https://revealjs.com/vertical-slides/#navigation-mode
        navigationMode: 'linear',

        // Randomizes the order of slides each time the presentation loads
        shuffle: false,

        // Turns fragments on and off globally
        fragments: true,

        // Flags whether to include the current fragment in the URL,
        // so that reloading brings you to the same fragment position
        fragmentInURL: false,

        // Flags if the presentation is running in an embedded mode,
        // i.e. contained within a limited portion of the screen
        embedded: false,

        // Flags if we should show a help overlay when the questionmark
        // key is pressed
        help: true,

        // Flags if it should be possible to pause the presentation (blackout)
        pause: true,

        // Flags if speaker notes should be visible to all viewers
        showNotes: false,

        // Global override for autoplaying embedded media (null/true/false)
        autoPlayMedia: null,

        // Global override for preloading lazy-loaded iframes (null/true/false)
        preloadIframes: null,

        // Number of milliseconds between automatically proceeding to the
        // next slide, disabled when set to 0, this value can be overwritten
        // by using a data-autoslide attribute on your slides
        autoSlide: 0,

        // Stop auto-sliding after user input
        autoSlideStoppable: true,

        // Use this method for navigation when auto-sliding
        autoSlideMethod: null,

        // Specify the average time in seconds that you think you will spend
        // presenting each slide. This is used to show a pacing timer in the
        // speaker view
        defaultTiming: null,

        // Enable slide navigation via mouse wheel
        mouseWheel: false,

        // The display mode that will be used to show slides
        display: 'block',

        // Hide cursor if inactive
        hideInactiveCursor: true,

        // Time before the cursor is hidden (in ms)
        hideCursorTime: 5000,

        // Opens links in an iframe preview overlay
        previewLinks: false,

        // Transition style (none/fade/slide/convex/concave/zoom)
        transition: 'none',

        // Transition speed (default/fast/slow)
        transitionSpeed: 'default',

        // Transition style for full page slide backgrounds
        // (none/fade/slide/convex/concave/zoom)
        backgroundTransition: 'none',

        // Number of slides away from the current that are visible
        viewDistance: 3,

        // Number of slides away from the current that are visible on mobile
        // devices. It is advisable to set this to a lower number than
        // viewDistance in order to save resources.
        mobileViewDistance: 2,

        // The "normal" size of the presentation, aspect ratio will be preserved
        // when the presentation is scaled to fit different resolutions. Can be
        // specified using percentage units.
        width: 1050,

        height: 700,

        // Factor of the display size that should remain empty around the content
        margin: 0.1,

        math: {
          mathjax: 'https://cdn.jsdelivr.net/npm/mathjax@2.7.9/MathJax.js',
          config: 'TeX-AMS_HTML-full',
          tex2jax: {
            inlineMath: [['\\(','\\)']],
            displayMath: [['\\[','\\]']],
            balanceBraces: true,
            processEscapes: false,
            processRefs: true,
            processEnvironments: true,
            preview: 'TeX',
            skipTags: ['script','noscript','style','textarea','pre','code'],
            ignoreClass: 'tex2jax_ignore',
            processClass: 'tex2jax_process'
          },
        },

        // reveal.js plugins
        plugins: [QuartoLineHighlight, PdfExport, RevealMenu, QuartoSupport,

          RevealMath,
          RevealNotes,
          RevealSearch,
          RevealZoom
        ]
      });
    </script>
    <!-- From: https://github.com/quarto-dev/quarto-cli/discussions/557 -->
    <script type="text/javascript">
      Reveal.on('ready', event => {
        if (event.indexh === 0) {
          document.querySelector("div.has-logo > img.slide-logo").style.display = "none";
        }
      });
      Reveal.addEventListener('slidechanged', (event) => {
        if (event.indexh === 0) {
          Reveal.configure({ slideNumber: null });
          document.querySelector("div.has-logo > img.slide-logo").style.display = "none";
        }
        if (event.indexh === 1) { 
          Reveal.configure({ slideNumber: 'c' });
          document.querySelector("div.has-logo > img.slide-logo").style.display = null;
        }
      });
    </script>
    
    <script>
      // htmlwidgets need to know to resize themselves when slides are shown/hidden.
      // Fire the "slideenter" event (handled by htmlwidgets.js) when the current
      // slide changes (different for each slide format).
      (function () {
        // dispatch for htmlwidgets
        function fireSlideEnter() {
          const event = window.document.createEvent("Event");
          event.initEvent("slideenter", true, true);
          window.document.dispatchEvent(event);
        }

        function fireSlideChanged(previousSlide, currentSlide) {
          fireSlideEnter();

          // dispatch for shiny
          if (window.jQuery) {
            if (previousSlide) {
              window.jQuery(previousSlide).trigger("hidden");
            }
            if (currentSlide) {
              window.jQuery(currentSlide).trigger("shown");
            }
          }
        }

        // hookup for slidy
        if (window.w3c_slidy) {
          window.w3c_slidy.add_observer(function (slide_num) {
            // slide_num starts at position 1
            fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);
          });
        }

      })();
    </script>

    <script id="quarto-html-after-body" type="application/javascript">
      window.document.addEventListener("DOMContentLoaded", function (event) {
        const tabsets =  window.document.querySelectorAll(".panel-tabset-tabby")
        tabsets.forEach(function(tabset) {
          const tabby = new Tabby('#' + tabset.id);
        });
        const isCodeAnnotation = (el) => {
          for (const clz of el.classList) {
            if (clz.startsWith('code-annotation-')) {                     
              return true;
            }
          }
          return false;
        }
        const onCopySuccess = function(e) {
          // button target
          const button = e.trigger;
          // don't keep focus
          button.blur();
          // flash "checked"
          button.classList.add('code-copy-button-checked');
          var currentTitle = button.getAttribute("title");
          button.setAttribute("title", "Copied!");
          let tooltip;
          if (window.bootstrap) {
            button.setAttribute("data-bs-toggle", "tooltip");
            button.setAttribute("data-bs-placement", "left");
            button.setAttribute("data-bs-title", "Copied!");
            tooltip = new bootstrap.Tooltip(button, 
              { trigger: "manual", 
                customClass: "code-copy-button-tooltip",
                offset: [0, -8]});
            tooltip.show();    
          }
          setTimeout(function() {
            if (tooltip) {
              tooltip.hide();
              button.removeAttribute("data-bs-title");
              button.removeAttribute("data-bs-toggle");
              button.removeAttribute("data-bs-placement");
            }
            button.setAttribute("title", currentTitle);
            button.classList.remove('code-copy-button-checked');
          }, 1000);
          // clear code selection
          e.clearSelection();
        }
        const getTextToCopy = function(trigger) {
          const outerScaffold = trigger.parentElement.cloneNode(true);
          const codeEl = outerScaffold.querySelector('code');
          for (const childEl of codeEl.children) {
            if (isCodeAnnotation(childEl)) {
              childEl.remove();
            }
          }
          return codeEl.innerText;
        }
        const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
          text: getTextToCopy
        });
        clipboard.on('success', onCopySuccess);
        if (window.document.getElementById('quarto-embedded-source-code-modal')) {
          const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
            text: getTextToCopy,
            container: window.document.getElementById('quarto-embedded-source-code-modal')
          });
          clipboardModal.on('success', onCopySuccess);
        }
          var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
          var mailtoRegex = new RegExp(/^mailto:/);
            var filterRegex = new RegExp('/' + window.location.host + '/');
          var isInternal = (href) => {
              return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
          }
          // Inspect non-navigation links and adorn them if external
         var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
          for (var i=0; i<links.length; i++) {
            const link = links[i];
            if (!isInternal(link.href)) {
              // undo the damage that might have been done by quarto-nav.js in the case of
              // links that we want to consider external
              if (link.dataset.originalHref !== undefined) {
                link.href = link.dataset.originalHref;
              }
            }
          }
        function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
          const config = {
            allowHTML: true,
            maxWidth: 500,
            delay: 100,
            arrow: false,
            appendTo: function(el) {
                return el.closest('section.slide') || el.parentElement;
            },
            interactive: true,
            interactiveBorder: 10,
            theme: 'light-border',
            placement: 'bottom-start',
          };
          if (contentFn) {
            config.content = contentFn;
          }
          if (onTriggerFn) {
            config.onTrigger = onTriggerFn;
          }
          if (onUntriggerFn) {
            config.onUntrigger = onUntriggerFn;
          }
            config['offset'] = [0,0];
            config['maxWidth'] = 700;
          window.tippy(el, config); 
        }
        const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
        for (var i=0; i<noterefs.length; i++) {
          const ref = noterefs[i];
          tippyHover(ref, function() {
            // use id or data attribute instead here
            let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
            try { href = new URL(href).hash; } catch {}
            const id = href.replace(/^#\/?/, "");
            const note = window.document.getElementById(id);
            if (note) {
              return note.innerHTML;
            } else {
              return "";
            }
          });
        }
        const findCites = (el) => {
          const parentEl = el.parentElement;
          if (parentEl) {
            const cites = parentEl.dataset.cites;
            if (cites) {
              return {
                el,
                cites: cites.split(' ')
              };
            } else {
              return findCites(el.parentElement)
            }
          } else {
            return undefined;
          }
        };
        var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
        for (var i=0; i<bibliorefs.length; i++) {
          const ref = bibliorefs[i];
          const citeInfo = findCites(ref);
          if (citeInfo) {
            tippyHover(citeInfo.el, function() {
              var popup = window.document.createElement('div');
              citeInfo.cites.forEach(function(cite) {
                var citeDiv = window.document.createElement('div');
                citeDiv.classList.add('hanging-indent');
                citeDiv.classList.add('csl-entry');
                var biblioDiv = window.document.getElementById('ref-' + cite);
                if (biblioDiv) {
                  citeDiv.innerHTML = biblioDiv.innerHTML;
                }
                popup.appendChild(citeDiv);
              });
              return popup.innerHTML;
            });
          }
        }
      });
      </script>
    

</body></html>